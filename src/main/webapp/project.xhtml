<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html>
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="jakarta.faces.facelets"
                template="./fetemplate.xhtml"
                xmlns:h="jakarta.faces.html"
                xmlns:p="primefaces"
                xmlns:f="jakarta.faces.core"
                xmlns:c="jakarta.tags.core">


    <ui:define name="headscripts">

        <style type="text/css">
            /* Compact PrimeFaces tree - reduce indentation */
            #formparts .ui-tree {
                padding: 0 !important;
            }
            #formparts .ui-tree .ui-treenode {
                padding: 0 !important;
            }
            #formparts .ui-tree .ui-treenode-children {
                padding-left: 8px !important;
            }
            #formparts .ui-tree .ui-treenode-content {
                padding: 2px 0 !important;
            }
            #formparts .ui-tree .ui-tree-toggler {
                margin-right: 2px !important;
            }
            /* Compact PrimeFaces selectOneMenu styling */
            .compact-dropdown.ui-selectonemenu {
                min-width: 90px !important;
                max-width: 110px !important;
                height: 22px !important;
            }
            .compact-dropdown .ui-selectonemenu-label {
                padding: 2px 4px !important;
                font-size: 9px !important;
                line-height: 16px !important;
            }
            .compact-dropdown .ui-selectonemenu-trigger {
                width: 18px !important;
                height: 20px !important;
            }
            .compact-dropdown .ui-selectonemenu-trigger .ui-icon {
                margin-top: 2px !important;
            }
            /* Panel styling for the dropdown items */
            .ui-selectonemenu-panel .ui-selectonemenu-items-wrapper {
                max-height: 150px !important;
            }
            .ui-selectonemenu-panel .ui-selectonemenu-item {
                padding: 3px 6px !important;
                font-size: 10px !important;
            }
        </style>

        <script crossorigin="anonymous" type="importmap">
             {
                 "imports": {
                     "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                     "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
                     }
             }
        </script>

        <script type="module">
            import { SheetMetalViewer } from '#{request.contextPath}/scripts/cad/sheet-metal/index.js';
            import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
            import * as THREE from 'three';

            let viewer = null;
            let gltfLoader = null;
            let currentModel = null;

            // Initialize the viewer when DOM is ready
            document.addEventListener('DOMContentLoaded', function() {
                viewer = new SheetMetalViewer({
                    containerId: 'viewport',
                    backgroundColor: 0x3a3a42,
                    enableCAM: true,
                    autoLoad: false
                });

                gltfLoader = new GLTFLoader();
                window.cadViewer = viewer;

                // Load GLB file into the viewer
                window.loadGLB = function(url) {
                    if (!viewer) return;

                    // Clear previous model
                    if (currentModel) {
                        viewer.getScene().remove(currentModel);
                        currentModel = null;
                    }

                    // Clear any sheet metal part
                    if (viewer.clearPart) {
                        viewer.clearPart();
                    }

                    gltfLoader.load(
                        url,
                        (gltf) => {
                            currentModel = gltf.scene;

                            gltf.scene.traverse(child => {
                                if (child.isMesh) {
                                    child.castShadow = true;
                                    child.receiveShadow = true;
                                    if (child.material) {
                                        const color = child.material.color ? child.material.color.clone() : new THREE.Color(0x888888);
                                        child.material = new THREE.MeshPhysicalMaterial({
                                            color: color,
                                            metalness: 0.1,
                                            roughness: 0.7,
                                            side: THREE.DoubleSide
                                        });
                                    }
                                }
                            });

                            viewer.getScene().add(gltf.scene);
                            viewer.fitToScene(gltf.scene);
                        },
                        (xhr) => {
                            if (xhr.lengthComputable) {
                                const percent = (xhr.loaded / xhr.total) * 100;
                                console.log('Loading: ' + percent.toFixed(1) + '%');
                            }
                        },
                        (err) => {
                            console.error('Error loading GLB:', err);
                        }
                    );
                };

                // Load simulation for sheet metal parts
                window.loadSimulation = function(basePath) {
                    if (!viewer) return;

                    // Clear previous GLB model
                    if (currentModel) {
                        viewer.getScene().remove(currentModel);
                        currentModel = null;
                    }

                    // Set the asset path to the simulation directory and load
                    // basePath is like /materiam/simserver/proj-uuid/cad-uuid/persid-cam_simulation/
                    viewer.assetPath = basePath;
                    viewer.loadPart('blueprint.json');
                };

                // Clear the viewer (called after deleting parts/assemblies)
                window.clearViewer = function() {
                    if (!viewer) return;

                    // Clear GLB model
                    if (currentModel) {
                        viewer.getScene().remove(currentModel);
                        currentModel = null;
                    }

                    // Clear sheet metal part if viewer supports it
                    if (viewer.clearPart) {
                        viewer.clearPart();
                    }

                    console.log('Viewer cleared');
                };
            });
        </script>

        <c:choose>
            <c:when test="#{projectController.activeProject != null and not empty projectController.activeProject.cadfiles and projectController.activeProject.cadfiles[0].root != null}">
                <script type="text/javascript">
                    document.addEventListener('DOMContentLoaded', function() {
                        function tryLoadGLB() {
                            if (typeof window.loadGLB === 'function') {
                                window.loadGLB('#{request.contextPath}/glbserver?projectid=#{projectController.activeProject.uuid}&amp;cadfile=#{projectController.activeProject.cadfiles[0].uuid}&amp;persid=#{projectController.activeProject.cadfiles[0].root.persid}');
                            } else {
                                setTimeout(tryLoadGLB, 100);
                            }
                        }
                        setTimeout(tryLoadGLB, 100);
                    });
                </script>
            </c:when>
            <c:when test="#{projectController.firstPart != null}">
                <script type="text/javascript">
                    document.addEventListener('DOMContentLoaded', function() {
                        function tryLoadGLB() {
                            if (typeof window.loadGLB === 'function') {
                                window.loadGLB('#{request.contextPath}/glbserver?projectid=#{projectController.activeProject.uuid}&amp;cadfile=#{projectController.firstCadFile.uuid}&amp;persid=#{projectController.firstPart.persid}');
                            } else {
                                setTimeout(tryLoadGLB, 100);
                            }
                        }
                        setTimeout(tryLoadGLB, 100);
                    });
                </script>
            </c:when>
        </c:choose>

    </ui:define>
    <ui:define name="top">
        
    </ui:define>
    
    
    
    




    <ui:define name="content">
                    <div style="color: white; "><div id="viewport"  /></div>
                    <div id="info" style="position: absolute;   position: absolute;  z-index: 10;
                            top: 10px;
                            left: 10px;
                            padding: 0px; width: 380px; ">
                        <h:form id="form" onkeypress="if (event.keyCode == 13) { saver(); event.preventDefault();}" style="margin-bottom: 0px;">
                            <p:remoteCommand name="saver" actionListener="#{projectController.save()}" update="nombre"  />
                            
                            <div style="background-color: #dedede; padding-top: 9px; padding-bottom: 7px;  border-top-right-radius: 8px; border-top-left-radius: 8px; color: black;">

                                    <span style="margin-left: 7px; font-family: Materiam; font-size: 24px;">
                                        <p:inplace id="nombre" editor="true" rendered="#{projectController.activeProject != null}">
                                            <p:inputText  value="#{projectController.activeProject.name}" required="true" label="text"/>

                                            <p:ajax event="save" listener="#{projectController.saveName}" update="nombre"/>
                                        </p:inplace>
                                    </span>
                                <c:if test="#{projectController.activeProject == null}">
                                    <span style="margin-left: 7px; font-family: Materiam; font-size: 14px;">CREATE A NEW PROJECT BY DROPPING FILES</span>
                                </c:if>
                            </div>
                        </h:form>
                        <div ondragover="dragging()" ondragleave="dragout()" ondrop="drop()" style="background-color: #f0f0f0;  padding: 0px; ">


                            <h:form id="dropzone"  enctype="multipart/form-data" style="margin-top: 0px; margin-bottom: 0px;">
                                <h:inputHidden id="wsid" value="#{userController.wsid}" />

                                <div style=" padding: 5px; ">

                                    
                                    <div class="grid_two" style="border:1px dashed grey; margin-bottom: 5px;">    
                                        <div id="statusimage"  style="background-image: url('images/sheetmetal.png'); 
                                            width:80px; height:70px;

                                            margin-left: 40px;
                                            background-size:     80px 60px;                      
                                            background-repeat:   no-repeat;
                                            background-position: center center;  
                                                ">

                                            <div id="updates" style="align-content: center; width:100%"></div>
                                        </div>
                                        <div style="margin-top:10px;">Drag &amp; drop additional files to project.</div>
                                    </div>
                                    <p:fileUpload listener="#{projectController.upload}"
                                                  dropZone="dropzone"
                                                  mode="advanced"
                                                  auto="true" 
                                                  multiple="true"
                                                  process="@all @form wsid"
                                                  >

                                    </p:fileUpload>
                                    <p:growl id="messages" showDetail="true" />   

                                </div>

                            </h:form> 

                        </div>              
                        
                        
                        <h:form id="formparts" style="margin:0px;">
                     
                            <!-- Assembly/Parts Tree -->
                            <div style="background-color: #5a5a5a; color: white; padding: 8px 12px; font-size: 14px; font-weight: bold;">
                                Assembly Tree
                            </div>
                            <div style="background-color: #e9e9e9; overflow-y: auto; overflow-x: hidden; max-height: 60vh; width: 100%;">

                                <p:tree id="assemblyTree" value="#{projectController.assemblyTree}" var="node"
                                       style="width:100%; border:none; box-sizing: border-box;">
                                    <p:treeNode type="assembly">
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <div style="box-shadow: 1px 1px 4px 0px rgba(0, 0, 0, 0.2); width: 135px; background-color: white;">
                                                <img style="width:130px; margin:2px; cursor: pointer; background-color: #ffffff;"
                                                     src="#{request.contextPath}/imageserver?projectid=#{projectController.activeProject.uuid}&amp;cadfile=#{node.cadfile.uuid}&amp;persid=#{node.assembly.persid}"
                                                     onclick="loadGLB('#{request.contextPath}/glbserver?projectid=#{projectController.activeProject.uuid}&amp;cadfile=#{node.cadfile.uuid}&amp;persid=#{node.assembly.persid}');"/>
                                            </div>
                                            <div style="flex: 1;">
                                                <div style="font-size: 13px; font-weight: bold; color: #333;">#{node.name}</div>
                                                <div style="font-size: 11px; color: #888;">Assembly | Qty: #{node.quantity}</div>
                                                <h:panelGroup rendered="#{node.quoted and node.unitCost.doubleValue() > 0}">
                                                    <div style="font-size: 10px; color: #666; margin-top: 3px;">Subtotal:</div>
                                                    <div style="font-size: 14px; color: #2196F3; font-weight: bold;">
                                                        <h:outputText value="#{node.unitCost}">
                                                            <f:convertNumber type="currency" currencySymbol="$" />
                                                        </h:outputText>
                                                        <h:panelGroup rendered="#{node.quantity > 1}">
                                                            <span style="font-size: 11px; color: #666;"> x #{node.quantity} = </span>
                                                            <h:outputText value="#{node.totalCost}">
                                                                <f:convertNumber type="currency" currencySymbol="$" />
                                                            </h:outputText>
                                                        </h:panelGroup>
                                                    </div>
                                                </h:panelGroup>
                                                <h:panelGroup rendered="#{node.quoted and node.unitCost.doubleValue() == 0}">
                                                    <div style="font-size: 11px; color: #999; margin-top: 3px;">No quotable parts</div>
                                                </h:panelGroup>
                                                <p:commandLink actionListener="#{projectController.deleteNode(node)}"
                                                               process="@this"
                                                               update=":formparts:assemblyTree :formparts:quoteTotals"
                                                               oncomplete="clearViewer()"
                                                               style="display: inline-block; margin-top: 5px; color: #c00; font-size: 14px; cursor: pointer;"
                                                               title="Remove assembly from project">
                                                    &#128465; Remove
                                                </p:commandLink>
                                            </div>
                                        </div>
                                    </p:treeNode>
                                    <p:treeNode type="part">
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <div style="box-shadow: 1px 1px 4px 0px rgba(0, 0, 0, 0.2); width: 135px; background-color: white;">
                                                <img style="width:130px; margin:2px; cursor: pointer; background-color: #ffffff;"
                                                     src="#{request.contextPath}/imageserver?projectid=#{projectController.activeProject.uuid}&amp;cadfile=#{node.cadfile.uuid}&amp;persid=#{node.part.persid}"
                                                     onclick="loadGLB('#{request.contextPath}/glbserver?projectid=#{projectController.activeProject.uuid}&amp;cadfile=#{node.cadfile.uuid}&amp;persid=#{node.part.persid}');"/>
                                            </div>
                                            <div style="flex: 1;">
                                                <div style="font-size: 13px; font-weight: bold; color: #333;">#{node.name}</div>
                                                <div style="font-size: 11px; color: #555;">#{node.shapeName}</div>
                                                <h:panelGroup rendered="#{node.quoted and node.rawMaterial != null}">
                                                    <div style="font-size: 10px; color: #666;">#{node.rawMaterial.name}</div>
                                                </h:panelGroup>
                                                <div style="font-size: 10px; color: #888;">Qty: #{node.quantity}</div>
                                                <h:panelGroup rendered="#{node.quoted}">
                                                    <h:panelGroup rendered="#{not empty node.availableAlloys}">
                                                        <p:selectOneMenu value="#{node.selectedAlloy}"
                                                                         converter="CategoryConverter"
                                                                         style="width: 100px; font-size: 9px;"
                                                                         styleClass="compact-dropdown">
                                                            <f:selectItems value="#{node.availableAlloys}" var="alloy"
                                                                           itemLabel="#{alloy.name}" itemValue="#{alloy}" />
                                                            <p:ajax listener="#{quotingEngine.changeAlloy(node)}"
                                                                    update=":formparts:assemblyTree :formparts:quoteTotals" />
                                                        </p:selectOneMenu>
                                                    </h:panelGroup>
                                                    <h:panelGroup rendered="#{empty node.availableAlloys}">
                                                        <span style="font-size: 9px; color: #c00;">No materials</span>
                                                    </h:panelGroup>
                                                    <div style="font-size: 13px; color: #4CAF50; font-weight: bold;">
                                                        <h:outputText value="#{node.unitCost}"><f:convertNumber type="currency" currencySymbol="$" /></h:outputText>
                                                        <h:panelGroup rendered="#{node.quantity > 1}">
                                                            <span style="font-size: 10px; color: #666;"> x #{node.quantity} = </span>
                                                            <h:outputText value="#{node.totalCost}"><f:convertNumber type="currency" currencySymbol="$" /></h:outputText>
                                                        </h:panelGroup>
                                                    </div>
                                                </h:panelGroup>
                                                <h:panelGroup rendered="#{not node.quoted}">
                                                    <div style="font-size: 11px; color: #999; margin-top: 2px;">
                                                        Not quotable
                                                    </div>
                                                </h:panelGroup>
                                                <h:panelGroup rendered="#{node.foldedSheetMetal and node.hasSimulation}">
                                                    <button type="button"
                                                            onclick="loadSimulation('#{request.contextPath}/simserver/#{node.simulationPath}');"
                                                            style="margin-top: 5px; padding: 4px 10px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">
                                                        &#9658; Play Bend Simulation
                                                    </button>
                                                </h:panelGroup>
                                                <h:panelGroup rendered="#{node.foldedSheetMetal and not node.hasSimulation}">
                                                    <span style="margin-top: 5px; padding: 4px 10px; background-color: #888; color: white; border: none; border-radius: 4px; font-size: 11px; display: inline-block;">
                                                        Bend Simulation Unavailable
                                                    </span>
                                                </h:panelGroup>
                                                <p:commandLink actionListener="#{projectController.deleteNode(node)}"
                                                               process="@this"
                                                               update=":formparts:assemblyTree :formparts:quoteTotals"
                                                               oncomplete="clearViewer()"
                                                               style="display: inline-block; margin-top: 5px; color: #c00; font-size: 14px; cursor: pointer;"
                                                               title="Remove part from project">
                                                    &#128465; Remove
                                                </p:commandLink>
                                            </div>
                                        </div>
                                    </p:treeNode>
                                </p:tree>

                            </div>

                            <h:panelGroup id="quoteTotals">
                                <div style="background-color: #e0e0e0; padding: 8px 12px; font-size: 12px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                        <span>Material Cost:</span>
                                        <h:outputText value="#{quotingEngine.totalMaterialCost}">
                                            <f:convertNumber type="currency" currencySymbol="$" />
                                        </h:outputText>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                        <span>Processing Cost:</span>
                                        <h:outputText value="#{quotingEngine.totalProcessingCost}">
                                            <f:convertNumber type="currency" currencySymbol="$" />
                                        </h:outputText>
                                    </div>
                                </div>
                            </h:panelGroup>

                            <div style="background-color: white;padding-top: 9px; padding-bottom: 7px;  border-bottom-right-radius: 8px; border-bottom-left-radius: 8px; color: black;">
                                <div class="grid_two">
                                    <div style="margin-left: 7px; font-family: Materiam; font-size: 24px;">
                                            Total

                                    </div>

                                    <div style="margin-left: 7px; font-family: Materiam; font-size: 24px;">
                                        <h:outputText style="font-weight: bold;" value="#{quotingEngine.totalCost}" styleClass="product-price" >
                                            <f:convertNumber currencySymbol="USD$" type="currency"/>
                                        </h:outputText>
                                    </div>
                                </div>

                            </div>

                            <p:confirmDialog global="true" showEffect="fade" hideEffect="fade">
                                <p:commandButton value="Yes" type="button" styleClass="ui-confirmdialog-yes" icon="pi pi-check" />
                                <p:commandButton value="No" type="button" styleClass="ui-confirmdialog-no" icon="pi pi-times" />
                            </p:confirmDialog>
                        </h:form>
                    </div>



    </ui:define>

    <ui:define name="bottom">
        
    </ui:define>

</ui:composition>
