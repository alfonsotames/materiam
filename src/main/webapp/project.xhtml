<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html>
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="jakarta.faces.facelets"
                template="./fetemplate.xhtml"
                xmlns:h="jakarta.faces.html"
                xmlns:p="primefaces"
                xmlns:f="jakarta.faces.core"
                xmlns:c="jakarta.tags.core">


    <ui:define name="headscripts">

        <script crossorigin="anonymous" type="importmap">
             {
                 "imports": {
                     "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                     "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
                     }
             }
        </script>

        <script type="module">
            import { SheetMetalViewer } from '#{request.contextPath}/scripts/cad/sheet-metal/index.js';
            import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
            import * as THREE from 'three';

            let viewer = null;
            let gltfLoader = null;
            let currentModel = null;

            // Initialize the viewer when DOM is ready
            document.addEventListener('DOMContentLoaded', function() {
                viewer = new SheetMetalViewer({
                    containerId: 'viewport',
                    backgroundColor: 0x3a3a42,
                    enableCAM: true,
                    autoLoad: false
                });

                gltfLoader = new GLTFLoader();
                window.cadViewer = viewer;

                // Load GLB file into the viewer
                window.loadGLB = function(url) {
                    if (!viewer) return;

                    // Clear previous model
                    if (currentModel) {
                        viewer.getScene().remove(currentModel);
                        currentModel = null;
                    }

                    // Clear any sheet metal part
                    if (viewer.clearPart) {
                        viewer.clearPart();
                    }

                    gltfLoader.load(
                        url,
                        (gltf) => {
                            currentModel = gltf.scene;

                            gltf.scene.traverse(child => {
                                if (child.isMesh) {
                                    child.castShadow = true;
                                    child.receiveShadow = true;
                                    if (child.material) {
                                        const color = child.material.color ? child.material.color.clone() : new THREE.Color(0x888888);
                                        child.material = new THREE.MeshPhysicalMaterial({
                                            color: color,
                                            metalness: 0.1,
                                            roughness: 0.7,
                                            side: THREE.DoubleSide
                                        });
                                    }
                                }
                            });

                            viewer.getScene().add(gltf.scene);
                            viewer.fitToScene(gltf.scene);
                        },
                        (xhr) => {
                            if (xhr.lengthComputable) {
                                const percent = (xhr.loaded / xhr.total) * 100;
                                console.log('Loading: ' + percent.toFixed(1) + '%');
                            }
                        },
                        (err) => {
                            console.error('Error loading GLB:', err);
                        }
                    );
                };

                // Load simulation for sheet metal parts
                window.loadSimulation = function(basePath) {
                    if (!viewer) return;

                    // Clear previous GLB model
                    if (currentModel) {
                        viewer.getScene().remove(currentModel);
                        currentModel = null;
                    }

                    // Set the asset path to the simulation directory and load
                    // basePath is like /materiam/simserver/proj-uuid/cad-uuid/persid-cam_simulation/
                    viewer.assetPath = basePath;
                    viewer.loadPart('blueprint.json');
                };
            });
        </script>

        <c:choose>
            <c:when test="#{projectController.activeProject != null and not empty projectController.activeProject.cadfiles and projectController.activeProject.cadfiles[0].root != null}">
                <script type="text/javascript">
                    document.addEventListener('DOMContentLoaded', function() {
                        function tryLoadGLB() {
                            if (typeof window.loadGLB === 'function') {
                                window.loadGLB('#{request.contextPath}/glbserver?projectid=#{projectController.activeProject.uuid}&amp;cadfile=#{projectController.activeProject.cadfiles[0].uuid}&amp;persid=#{projectController.activeProject.cadfiles[0].root.persid}');
                            } else {
                                setTimeout(tryLoadGLB, 100);
                            }
                        }
                        setTimeout(tryLoadGLB, 100);
                    });
                </script>
            </c:when>
            <c:when test="#{projectController.firstPart != null}">
                <script type="text/javascript">
                    document.addEventListener('DOMContentLoaded', function() {
                        function tryLoadGLB() {
                            if (typeof window.loadGLB === 'function') {
                                window.loadGLB('#{request.contextPath}/glbserver?projectid=#{projectController.activeProject.uuid}&amp;cadfile=#{projectController.firstCadFile.uuid}&amp;persid=#{projectController.firstPart.persid}');
                            } else {
                                setTimeout(tryLoadGLB, 100);
                            }
                        }
                        setTimeout(tryLoadGLB, 100);
                    });
                </script>
            </c:when>
        </c:choose>

    </ui:define>
    <ui:define name="top">
        
    </ui:define>
    
    
    
    




    <ui:define name="content">
                    <div style="color: white; "><div id="viewport"  /></div>
                    <div id="info" style="position: absolute;   position: absolute;  z-index: 10;
                            top: 10px;
                            left: 10px;
                            padding: 0px; width: 380px; ">
                        <h:form id="form" onkeypress="if (event.keyCode == 13) { saver(); event.preventDefault();}" style="margin-bottom: 0px;">
                            <p:remoteCommand name="saver" actionListener="#{projectController.save()}" update="nombre"  />
                            
                            <div style="background-color: #dedede; padding-top: 9px; padding-bottom: 7px;  border-top-right-radius: 8px; border-top-left-radius: 8px; color: black;">

                                    <span style="margin-left: 7px; font-family: Materiam; font-size: 24px;">
                                        <p:inplace id="nombre" editor="true" rendered="#{projectController.activeProject != null}">
                                            <p:inputText  value="#{projectController.activeProject.name}" required="true" label="text"/>

                                            <p:ajax event="save" listener="#{projectController.saveName}" update="nombre"/>
                                        </p:inplace>
                                    </span>
                                <c:if test="#{projectController.activeProject == null}">
                                    <span style="margin-left: 7px; font-family: Materiam; font-size: 14px;">CREATE A NEW PROJECT BY DROPPING FILES</span>
                                </c:if>
                            </div>
                        </h:form>
                        <div ondragover="dragging()" ondragleave="dragout()" ondrop="drop()" style="background-color: #f0f0f0;  padding: 0px; ">


                            <h:form id="dropzone"  enctype="multipart/form-data" style="margin-top: 0px; margin-bottom: 0px;">
                                <h:inputHidden id="wsid" value="#{userController.wsid}" />

                                <div style=" padding: 5px; ">

                                    
                                    <div class="grid_two" style="border:1px dashed grey; margin-bottom: 5px;">    
                                        <div id="statusimage"  style="background-image: url('images/sheetmetal.png'); 
                                            width:80px; height:70px;

                                            margin-left: 40px;
                                            background-size:     80px 60px;                      
                                            background-repeat:   no-repeat;
                                            background-position: center center;  
                                                ">

                                            <div id="updates" style="align-content: center; width:100%"></div>
                                        </div>
                                        <div style="margin-top:10px;">Drag &amp; drop additional files to project.</div>
                                    </div>
                                    <p:fileUpload listener="#{projectController.upload}"
                                                  dropZone="dropzone"
                                                  mode="advanced"
                                                  auto="true" 
                                                  multiple="true"
                                                  process="@all @form wsid"
                                                  >

                                    </p:fileUpload>
                                    <p:growl id="messages" showDetail="true" />   

                                </div>

                            </h:form> 

                        </div>              
                        
                        
                        <h:form id="formparts" style="margin:0px;">
                     
                            <!--<div style="background-color: #5a5a5a; color: white; padding: 5px; font-size: 14px;">Manufacturing Order:</div>-->
                            <div style="color: white; background-color: #e9e9e9; overflow-y: scroll;  max-height: 60vh;">

                                
                                
                                
                                <p:tree id="assemblyTree" value="#{projectController.assemblyTree}" var="node"
                                       style="width:100%; border:none;">
                                    <p:treeNode type="assembly">
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <div style="box-shadow: 1px 1px 4px 0px rgba(0, 0, 0, 0.2); width: 135px; background-color: white;">
                                                <img style="width:130px; margin:2px; cursor: pointer; background-color: #ffffff;"
                                                     src="#{request.contextPath}/imageserver?projectid=#{projectController.activeProject.uuid}&amp;cadfile=#{node.cadfile.uuid}&amp;persid=#{node.assembly.persid}"
                                                     onclick="loadGLB('#{request.contextPath}/glbserver?projectid=#{projectController.activeProject.uuid}&amp;cadfile=#{node.cadfile.uuid}&amp;persid=#{node.assembly.persid}');"/>
                                            </div>
                                            <div style="flex: 1;">
                                                <div style="font-size: 13px; font-weight: bold; color: #333;">#{node.name}</div>
                                                <div style="font-size: 11px; color: #888;">Qty: #{node.quantity}</div>
                                            </div>
                                        </div>
                                    </p:treeNode>
                                    <p:treeNode type="part">
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <div style="box-shadow: 1px 1px 4px 0px rgba(0, 0, 0, 0.2); width: 135px; background-color: white;">
                                                <img style="width:130px; margin:2px; cursor: pointer; background-color: #ffffff;"
                                                     src="#{request.contextPath}/imageserver?projectid=#{projectController.activeProject.uuid}&amp;cadfile=#{node.cadfile.uuid}&amp;persid=#{node.part.persid}"
                                                     onclick="loadGLB('#{request.contextPath}/glbserver?projectid=#{projectController.activeProject.uuid}&amp;cadfile=#{node.cadfile.uuid}&amp;persid=#{node.part.persid}');"/>
                                            </div>
                                            <div style="flex: 1;">
                                                <div style="font-size: 13px; font-weight: bold; color: #333;">#{node.name}</div>
                                                <div style="font-size: 11px; color: #666;">Qty: #{node.quantity} | $0.00</div>
                                                <h:panelGroup rendered="#{node.foldedSheetMetal and node.hasSimulation}">
                                                    <button type="button"
                                                            onclick="loadSimulation('#{request.contextPath}/simserver/#{node.simulationPath}');"
                                                            style="margin-top: 5px; padding: 4px 10px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">
                                                        &#9658; Play Bend Simulation
                                                    </button>
                                                </h:panelGroup>
                                                <h:panelGroup rendered="#{node.foldedSheetMetal and not node.hasSimulation}">
                                                    <span style="margin-top: 5px; padding: 4px 10px; background-color: #888; color: white; border: none; border-radius: 4px; font-size: 11px; display: inline-block;">
                                                        Bend Simulation Unavailable
                                                    </span>
                                                </h:panelGroup>
                                            </div>
                                        </div>
                                    </p:treeNode>
                                </p:tree>
                                
                                
                                
                                
                                
                            </div>

                            <div style="background-color: white;padding-top: 9px; padding-bottom: 7px;  border-bottom-right-radius: 8px; border-bottom-left-radius: 8px; color: black;">
                                <div class="grid_two">
                                    <div style="margin-left: 7px; font-family: Materiam; font-size: 24px;">
                                            Total 

                                    </div>
                                 
                                    <div style="margin-left: 7px; font-family: Materiam; font-size: 24px;">
                                        <h:outputText style="font-weight: bold;" value="#{projectController.total}" styleClass="product-price" >
                                            <f:convertNumber currencySymbol="USD$" type="currency"/>
                                        </h:outputText>                                           
                                    </div>
                                </div>
                                
                            </div>
                        </h:form>   
                    </div>

        

    </ui:define>

    <ui:define name="bottom">
        
    </ui:define>

</ui:composition>
