<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="jakarta.faces.facelets" 
      xmlns:h="jakarta.faces.html"
      xmlns:f="jakarta.faces.core">

    <h:head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <h:outputStylesheet name="/css/default.css"/>
        <h:outputStylesheet name="/css/cssLayout.css"/>
        <title>MATERIAM</title>
        
        <ui:insert name="headscripts"></ui:insert>

    </h:head>

    <h:body>
            <div id="top" >
                <h:form id="headerform">
                    <div class="grid_three" >
                        <div onclick="location.href='#{request.contextPath}/'" style="cursor: pointer; font-family: Materiam; 
                                                            font-size: 38px; color: white; margin-left: 10px; width: 240px; 
                                                            ">MATERIAM</div>
                        <div>
                            <div id="updates" style="background-color: #0a0a0a; color: #ffffff; font-family: 'Courier New', Consolas, monospace; font-size: 10px; padding: 6px 10px; border-radius: 4px; border: 1px solid #333; height: 40px; width: 100%; box-sizing: border-box; text-align: left; overflow-y: auto; white-space: pre-wrap; line-height: 1.4;"><ui:repeat value="#{userController.consoleMessages}" var="msg">#{msg}<br/></ui:repeat></div>
                            <!-- #{request.session.id} -->
                        </div>
                        <div class="grid_four">
                            <ui:insert name="top"></ui:insert>
                            <div style="width:160px; ">
                                
                                <div><h:outputText id="username"  value="Welcome #{userController.user.name}" rendered="#{userController.user != null}" /></div>
                                <div>
                                    <h:outputLink id="admin"  value="#{request.contextPath}/admin" rendered="#{request.isUserInRole('ADMIN')}" style="color: white;">ADMIN</h:outputLink>
                                </div>                                 

                                <h:panelGroup rendered="#{userController.user == null}">
                                    <a href="login.xhtml">Login</a>
                                </h:panelGroup>
                                
                            </div>
                            <div style="width:100px; ">
                                <div><h:outputLink value="#{request.contextPath}/project.xhtml"><h:outputText value="#{projectController.activeProject != null ? 'Active Project' : 'New Project'}" /></h:outputLink></div>
                            </div>
                                
                            <div>
                                <div><h:outputLink value="#{request.contextPath}/account">Account</h:outputLink></div>
                            </div>
                            <div>
                                <div><h:commandLink value="Logout" action="#{userController.logout}" rendered="#{userController.user != null}" /></div>
                            </div>                                
                        </div>   
                    </div>
                </h:form>    
            </div>
            <div class="center_content" >
                <ui:insert name="content">Content</ui:insert>
            </div>
            <div  id="bottom" >
                <div class="grid_two">
                    <div class="grid_four">
                        <div><img style="width:70px;" src="#{request.contextPath}/images/americansteel.png" /></div>
                        <div><img style="width:70px;" src="#{request.contextPath}/images/americanaluminium.png" /></div>
                        <div><span style="color:white; font-size: 24px">ISO9001:2015</span></div>
                        <div><ui:insert name="bottom"></ui:insert></div>
                    </div>
                    <div></div>                   
                </div>

                
            </div>
        <h:form id="submitwsid"  enctype="multipart/form-data">
            
            <h:inputHidden id="wsid" value="#{userController.wsid}" />
            <h:commandButton id="hiddenButton" action="#{userController.registerWsid}" style="display:none;">
                <f:ajax execute="@form" render="submitwsid" />
            </h:commandButton>                            
        </h:form>        
        <script type="text/javascript">
            var wsUri = "ws://" + document.location.host + "#{request.contextPath}/notifier";
            var websocket = new WebSocket(wsUri);
            
            websocket.onerror = function (evt) {
                console.log(evt.data);
            };
            websocket.onopen = function (evt) {
                console.log("Connected to "+wsUri);
                
                //console.log(evt.data);
             
            };
            
            websocket.onmessage = function (evt) {
                console.log("Message received "+evt.data);
                if (evt.data.startsWith("SESSIONID:")) {
                    
                    var wsSessionId = event.data.substring(10);

                    // put it into the hidden input
                    //document.getElementById("dropzone:wsid").value = wsSessionId;
                    document.getElementById("submitwsid:wsid").value = wsSessionId;

                    console.log("Stored WebSocket id:", wsSessionId);
                    document.getElementById('submitwsid:hiddenButton').click();
                } else {
                    var updatesDiv = document.getElementById("updates");
                    var content = updatesDiv.innerHTML;
                    var lines = content.split(/\x3cbr\s*\/?\x3e/i).filter(function(line) { return line.trim() !== ''; });
                    lines.push(event.data);
                    if (lines.length > 3) {
                        lines = lines.slice(lines.length - 3);
                    }
                    updatesDiv.innerHTML = lines.join('\x3cbr\x3e');
                    updatesDiv.scrollTop = updatesDiv.scrollHeight;
                }
            };
            
        </script>        
    </h:body>

</html>
